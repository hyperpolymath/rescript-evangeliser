# SPDX-License-Identifier: PMPL-1.0-or-later
name: npm/bun Blocker
on: [push, pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for npm/bun usage in new files
        run: |
          # Check for new bun.lockb files
          NEW_BUN=$(git diff --name-only --diff-filter=A HEAD~1 2>/dev/null | grep -E 'bun\.lockb$' || true)

          # Check for npm scripts calling npm/bun in new or modified files
          NPM_CALLS=$(git diff HEAD~1 2>/dev/null | grep -E '^\+.*(npm|bun)\s+(run|install|start|test|build)' | grep -v '#' || true)

          ERRORS=""

          if [ -n "$NEW_BUN" ]; then
            ERRORS="${ERRORS}New bun.lockb detected. Use Deno instead.
${NEW_BUN}
"
          fi

          if [ -n "$NPM_CALLS" ]; then
            ERRORS="${ERRORS}npm/bun commands in new code. Use Deno tasks instead.
${NPM_CALLS}
"
          fi

          if [ -n "$ERRORS" ]; then
            echo -e "$ERRORS"
            echo ""
            echo "Per language policy, use Deno instead of npm/bun for:"
            echo "  - Package management: deno.json imports"
            echo "  - Task running: deno task <name>"
            echo "  - Scripts: deno run script.ts"
            exit 1
          fi

          echo "Deno policy enforced (no new npm/bun usage)"

      - name: Verify deno.json exists
        run: |
          if [ ! -f "deno.json" ]; then
            echo "Warning: deno.json not found"
            echo "Consider adding deno.json for Deno configuration"
          else
            echo "deno.json found"
          fi
